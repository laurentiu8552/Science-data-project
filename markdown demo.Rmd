
### lattice

```{r}
lattice::show.settings() #just a test to see that the R markdown works
library(tidyverse)
library(caret)
library(caTools)
library(DataExplorer)
library(dplyr)  
library(ggplot2)  
library(visdat)   
library(recipes)  
library(rsample)
library(forecast)
library(MASS)
library(rfm)
```

```{r}
# Load necessary libraries
library(readxl)
# Load the dataset
data <- read_excel("jysk_case_competition_final.xlsx")

# Check the structure of the dataset to see variable types
str(data)

# Convert the 'date' column to Date type
data$date <- as.Date(data$date, format = "%d.%m.%Y")

# Convert all non-numeric columns (besides 'date') to factors
data[] <- lapply(data, function(x) if(is.character(x)) as.factor(x) else x)

# Check the structure of the dataset to confirm the changes
str(data)

# Rename the column 'order_value_ex_vat_ex_freight' to 'Revenue'
data <- data %>%
  rename(revenue = order_value_ex_vat_ex_freight)

str(data)
```

```{r}
#APPLICATION1
#Cleaning of data

#Cleaning the data on na customers but also revenue above 0
data_clean_rfm <- data %>% 
  filter(!is.na(customer_id) & revenue > 0)


#Visualization of the 3 rfm variables

# Revenue histogram
hist(data_clean_rfm$revenue, main = "Histogram of Revenue", col = "blue", border = "black")
# Check for NAs
sum(is.na(data_clean_rfm$revenue))      # Count NAs in revenue



# Customer ID bar plot
barplot(table(data_clean_rfm$customer_id), main = "Customer ID Distribution", col = "blue")
sum(is.na(data_clean_rfm$customer_id))  # Count NAs in customer_id


# Date bar plot
barplot(table(data_clean_rfm$date), main = "Date Distribution", col = "blue")
sum(is.na(data_clean_rfm$date))         # Count NAs in date

#CAN BE SEEN no NAs and also no negative variables, can proceed with the RFM model running

```



```{r}
#RFM model 

analysis_date = as.Date("2024-12-31")

# Run the RFM analysis
rfm_result <- rfm_table_order(data_clean_rfm, 
                              customer_id, 
                              date, 
                              revenue, 
                              analysis_date = analysis_date)

# Step 3: Visualize RFM Results
# Heatmap visualization of RFM scores
rfm_plot_heatmap(rfm_result)

# Bar chart of RFM scores
rfm_bar_chart(rfm_result)




# Step 4: Segment Customers based on RFM scores
# Define RFM segment categories
segment_names <- c("Champions", "Loyal Customers", "Potential Loyalist", 
                   "New Customers", "Promising", "Need Attention", "About To Sleep", 
                   "At Risk", "Can't Lose Them", "Lost")

# Set upper and lower bounds for Recency, Frequency, and Monetary
recency_lower   <- c(4, 2, 3, 4, 3, 2, 2, 1, 1, 1)
recency_upper   <- c(5, 5, 5, 5, 4, 3, 3, 2, 1, 2)
frequency_lower <- c(4, 3, 1, 1, 1, 2, 1, 2, 4, 1)
frequency_upper <- c(5, 5, 3, 1, 1, 3, 2, 5, 5, 2)
monetary_lower  <- c(4, 3, 1, 1, 1, 2, 1, 2, 4, 1)
monetary_upper  <- c(5, 5, 3, 1, 1, 3, 2, 5, 5, 2)

# Apply segments based on RFM scores
segment <- rfm_segment(rfm_result, 
                       segment_names,
                       recency_lower, recency_upper,
                       frequency_lower, frequency_upper,
                       monetary_lower, monetary_upper)

# View the segmented customers
head(segment)

# Step 5: Visualize RFM Segments
# Recency by segment
rfm_plot_median_recency(segment, sort = TRUE)

# Monetary by segment
rfm_plot_median_monetary(segment, sort = TRUE)

# Frequency by segment
rfm_plot_median_frequency(segment, sort = TRUE)
```

```{r}
#APPLICATION 2

#starting with descriptive statistics

#Cleaning the data on na customers but also revenue above 0
data_application2 <- data %>% 
  filter(!is.na(customer_id))




```