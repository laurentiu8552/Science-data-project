### lattice

```{r Libraries necessary}
library(tidyverse)
library(caret)
library(caTools)
library(DataExplorer)
library(dplyr)  
library(ggplot2)  
library(visdat)   
library(recipes)  
library(rsample)
library(forecast)
library(MASS)
library(rfm)

library(ggplot2)
    library(DataExplorer)
    library(GGally)
    library(BTYD)
    library(plyr)
    library(ggplot2)
    library(lubridate)
    library(reshape2)
    library(BTYDplus)
    library(ggpubr)
    library(Hmisc)
    library(tibble)
    library(Metrics)
    library(magrittr)
    library(dplyr)
    library(car)
    library(rfm)
    library(kableExtra)
    library(reshape2)
    library(tidyverse)
    library(knitr)
    library(flexclust)
    library(clue)
    library(openxlsx)

library(tidygeocoder)
library(sf)
```

```{r Read the file  - data}
library(readxl)
# Load the dataset
data <- read_excel("jysk_case_competition_final.xlsx")

data <- data[!duplicated(data),]

# Check the structure of the dataset to see variable types
str(data)

library(dplyr)

# 1. Convert empty strings in your original data columns to NA.
data <- data %>%
  mutate(
    product_group_level_1 = na_if(product_group_level_1, ""),
    product_category_level_2 = na_if(product_category_level_2, "")
  )

# 1) Define the 'product_title' vector (202 entries)
product_title <- c(
  "Mirror NORDBORG 70×90 silver",
  "MA 160x200cm PLUS F30 DREAMZONE",
  "Sofa bed FALSLEV grey",
  "Bed frame KUNGSHAMN 160x200 light grey",
  "Bed frame KUNGSHAMN 140x200 light grey",
  "TO KARLSTAD 50x100cm yellow KR",
  "MA 90x190cm PLUS F30 DREAMZONE",
  "TM 180x200cm GOLD T30 WELLPUR",
  "MA 160x200cm GOLD F85 white/blue WELLPUR",
  "MA 160x200cm BASIC S30",
  "MA 180x200cm GOLD S110 DREAMZONE",
  "MA 140x200cm PLUS S20 DREAMZONE",
  "Dining chair PEBRINGE velvet green/black",
  "MA 90x200cm PLUS F30 DREAMZONE",
  "MA 180x200cm GOLD F115 DREAMZONE",
  "MA 140x200cm BASIC S30",
  "DCSS INGA Percale DBL grey w/piping KR",
  "Pouffe GISLEV 65x35 w/storage asphalt",
  "DCSS ANDREA DBL sand/white DBF",
  "GT KARLSTAD 40x60cm yellow KR",
  "MA 160x200cm GOLD F40 DREAMZONE",
  "Desk IKAST 42x60 black",
  "FC KARLSTAD 28x30cm light green KR",
  "MA 160x200cm BASIC S5",
  "Bed frame LIMFJORDEN 140x200 white",
  "FC KARLSTAD 28x30cm yellow KR",
  "SHE Fitted FRIDA 160x200x35 white KR",
  "MA 140x200cm GOLD F85 white/dark grey",
  "TO KARLSTAD 50x100cm light green KR",
  "Footstool ULDUM grey/black",
  "Bed frame LIMFJORDEN 160x200 white",
  "MA 140x200cm GOLD F115 DREAMZONE",
  "MA 160x200cm PLUS S55 DREAMZONE",
  "Shelving unit VANDBORG 4 s/2 d oak/black",
  "MA 90x200cm BASIC S30",
  "MA 140x200cm GOLD F40 DREAMZONE",
  "MA 80x200cm BASIC S30",
  "String curtain YXLAN 1x90x245 olive",
  "SHE Fitted FRIDA 180x200x35 white KR",
  "MA 90x200cm PLUS S20 DREAMZONE",
  "WG KARLSTAD 14x20cm yellow KR",
  "SHE Fitted FRIDA 160x200x35 beige KR",
  "MA 160x200cm GOLD F85 white/dark grey",
  "TM 120x200cm GOLD T50 grey",
  "MAAC Ø5xH23cm legs metal 5 pcs",
  "CCU SELJE 40x40x8 light blue",
  "Bed frame MANDERUP 140x200 wild oak",
  "Wardrobe EVETOFTE 143x220 white",
  "MAAC Ø5xH23cm legs metal 4 pcs",
  "MA 140x200cm PLUS S55 DREAMZONE",
  "TM 160x200cm GOLD T50 grey",
  "MA 120x200cm GOLD F30 arrows WELLPUR",
  "MA 90x200cm PLUS S55 DREAMZONE",
  "TM 140x200cm GOLD T50 grey",
  "MA 80x200cm GOLD F40 DREAMZONE",
  "SHE Fitted FRIDA 160x200x35 taupe KR",
  "SHE Fitted FRIDA 90x200x35 white KR",
  "Sofa bed MARSLEV 3 seater dark grey",
  "MA 180x200cm PLUS S20 DREAMZONE",
  "Stool VALLEKILDE Ø30 natural/white",
  "MA 180x200cm GOLD F85 white/blue WELLPUR",
  "BS KARLSTAD 100x150cm yellow KR",
  "PM KUNGSMYNTA Ø38 dark grey SDP",
  "SHE Fitted FRIDA 140x200x35 grey KR",
  "SHE Fitted FRIDA 160x200x35 grey KR",
  "CUS 200g KARITINDEN fibre 40x40cm",
  "MA 160x200cm GOLD S100 DREAMZONE",
  "Vase VILHELM Ø9xH12cm blue",
  "Pouffe AUNING 38x38 velvet grey",
  "Shelving unit JANNERUP wide 3 shel. oak",
  "MA 140x200cm GOLD F30 dots WELLPUR",
  "BT Velour LOL SURPRISE 70x140cm 2023",
  "SHE JEANETTE 240x260 blue KRONBORG",
  "MA 160x200cm GOLD F30 dots WELLPUR",
  "TM 80x200cm GOLD T50 grey",
  "SHE Fitted FRIDA 90x200x35 taupe KR",
  "SHE Fitted FRIDA 90x200x35 beige KR",
  "DCS TOVE DBL blue w/piping DBF",
  "MA 80x200cm PLUS S20 DREAMZONE",
  "SHE Fitted FRIDA 90x200x35 grey KR",
  "BT KARLSTAD 70x140cm light green KR",
  "HB 90x115cm H10 PLAIN Grey-28 DREAMZONE",
  "Nest of tables BRABRAND Ø70/50 natural/b",
  "CT 90x200cm PLUS C40 Black-07 DREAMZONE",
  "MA 140x200cm GOLD S100 DREAMZONE",
  "MA 180x200cm GOLD F40 DREAMZONE",
  "COD VEDDE 3 drawers white",
  "WG KARLSTAD 14x20cm light green KR",
  "CT 140x200cm PLUS C40 Black-07 DREAMZONE",
  "MA 120x200cm GOLD F30 dots WELLPUR",
  "MA 180x200cm GOLD F30 plain WELLPUR",
  "MA 180x200cm GOLD F30 dots WELLPUR",
  "DCS MARION SGL rose DBF KRONBORG",
  "DCS TOVE SGL blue w/piping DBF",
  "Vase PETTER Ø15xH15cm sand",
  "SHE Fitted FRIDA 180x200x35 beige KR",
  "Sofa bed OREVAD dark grey",
  "Desk SKOVLUNDE 60x120 nat. oak",
  "GT KARLSTAD 40x60cm light green KR",
  "SHE Fitted FRIDA 180x200x35 taupe KR",
  "SHE Fitted FRIDA 140x200x35 white KR",
  "TM 180x200cm GOLD T50 grey",
  "MA 180x200cm GOLD S100 DREAMZONE",
  "Bed frame PORSGRUNN 80/160x200 white",
  "Pouffe HOLEBY 40x40 w/storage black",
  "MA 80x200cm PLUS S55 DREAMZONE",
  "MA 80x200cm GOLD S100 DREAMZONE",
  "Bench BARUP velvet grey",
  "DCSS INGA Percale SGL grey w/piping KR",
  "MA 160x200cm GOLD F30 plain WELLPUR",
  "Bed frame LIMFJORDEN 90x200 white",
  "SHE JEANETTE 240x260 white KRONBORG",
  "Pouffe HOLEBY 80x40 w/storage black",
  "SHE Fitted FRIDA 180x200x35 grey KR",
  "PIL 200g FALKETIND 40x40cm",
  "MA 120x200cm GOLD F30 plain WELLPUR",
  "MA 80x200cm GOLD F30 dots WELLPUR",
  "MA 180x200cm PLUS S55 DREAMZONE",
  "Sofa bed OREVAD light grey",
  "SHE JEANETTE 240x260 taupe KRONBORG",
  "MA 90x190cm PLUS S55 DREAMZONE",
  "Bar table SANDBY 71x128 nat. oak",
  "CUR GOSSA 1x140x300 white",
  "Armchair ULDUM grey/black",
  "MA 90x200cm GOLD F30 plain WELLPUR",
  "TM 180x200cm GOLD T65 white/dark grey",
  "SHE JEANETTE 150x250 l. grey KRONBORG",
  "Decorative tray HEIMER W20xL29cm natural",
  "SHE JEANETTE 150x250 blue KRONBORG",
  "SHE JEANETTE 150x250 white KRONBORG",
  "DCSS MARY SGL coral",
  "DCS BRITT Flannel DBL sand/blue",
  "SHE JEANETTE 150x250 taupe KRONBORG",
  "TM 180x200cm GOLD T30 plain WELLPUR",
  "SHE JEANETTE 240x260 l. grey KRONBORG",
  "MA 140x200cm PLUS F30 DREAMZONE",
  "DCS SCOTTI Flannel SGL grey/white",
  "DCS SONIC SGL blue DBF",
  "CT 160x200cm GOLD C50 storage Grey-41",
  "DCSS TESSA Sateen DBL latte",
  "MA 140x200cm GOLD F30 plain WELLPUR",
  "MA 90x190cm GOLD F115 DREAMZONE",
  "MA 90x200cm GOLD F85 white/blue WELLPUR",
  "MA 90x200cm GOLD F30 dots WELLPUR",
  "COD JUNGEN 4 drawers wild oak",
  "Pedestal THYGE Ø20xH34cm natural",
  "CUR HIRSHOLM 1x135x300 off-white",
  "WG KARLSTAD 15X20cm light green KR",
  "DCSS ANDREA SGL sand/white DBF",
  "HB 140x122cm H70 BUTTONS Grey-28",
  "MA 80x200cm GOLD F30 plain WELLPUR",
  "HB 160x122cm H70 BUTTONS Grey-28",
  "SHE BOLETTE 220x250 grey",
  "DCS PEPPA PIG 2023 SGL rose DBF",
  "HB 140x115cm H10 PLAIN Grey-28",
  "MA 140x200cm GOLD F120 WELLPUR",
  "Shelving unit TISTRUP 3 shel. white/oak",
  "CT 160x200cm PLUS C40 Black-07 DREAMZONE",
  "HB 160x115cm H10 PLAIN Grey-28",
  "MA 80x200cm GOLD F120 WELLPUR",
  "Decorative box EDVARD W12xL12xH6cm glass",
  "Nest of tables FALSLED Ø50/40 glass",
  "CUR SEKKEN 1x140x300 grey w/stripe",
  "MA 90x190cm GOLD F120 WELLPUR",
  "DCS POKEMON 2023 SGL yellow DBF",
  "Side table KRAGEVIG Ø50xH50 hardwood",
  "Wall lamp LINUS W12xL25xH16cm natural",
  "GC chair seat UDSIGTEN sand",
  "DCSS TESSA Sateen SGL latte",
  "DCS FROZEN 2023 SGL purple DBF",
  "TM 120x200cm GOLD T65 white/lt grey",
  "MA 80x200cm GOLD F85 white/blue WELLPUR",
  "HB 160x122cm H70 BUTTONS Grey-23",
  "CUR UNDEN 1x135x300 stripe white",
  "HB 140x115cm H10 PLAIN Grey-34",
  "CT 180x200cm PLUS C40 Black-07 DREAMZONE",
  "DCS MINECRAFT 2023 SGL blue DBF",
  "MA 90x200cm GOLD S100 DREAMZONE",
  "Office chair NIMTOFTE black",
  "Sofa bed chaise longue VEJLBY light sand",
  "Dining chair PEBRINGE velvet grey/black",
  "Dining chair PEBRINGE grey/black",
  "HB 140x115cm H10 PLAIN Black-07",
  "HB 160x115cm H10 PLAIN Grey-34",
  "HB 180x122cm H70 BUTTONS Grey-28",
  "DCS WILMA SGL pink DBF KRONBORG",
  "TM 120x200cm GOLD T30 dots WELLPUR",
  "HB 90x122cm H70 BUTTONS Grey-28",
  "TM 140x200cm GOLD T30 dots WELLPUR",
  "MA 180x200cm GOLD F85 white/dark grey",
  "TM 90x190cm GOLD T30 WELLPUR",
  "FC KARLSTAD 28x30cm light grey KR",
  "CCU DVERGJAMNE 34x36x2 grey",
  "MA 120x200cm GOLD F30 white WELLPUR",
  "Slatted base 90x200cm grey",
  "Sofa bed HOLSTEBRO black",
  "Onion jar HUBERT Ø18xH20cm sand",
  "HB 180x115cm H10 PLAIN Grey-28",
  "TM 120x200cm GOLD T65 white/blue WELLPUR",
  "MA 160x200cm GOLD F35 DREAMZONE",
  "MA 160x200cm GOLD F100 DREAMZONE",
  "MA 180x200cm GOLD S50 DREAMZONE"
)

# 2) Define the 'product_group_level_1' vector (202 entries)
product_group_level_1 <- c(
  "Furniture",
  "Mattresses",
  "Furniture",
  "Furniture",
  "Furniture",
  "Bathroom",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Furniture",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Bed Linen",
  "Furniture",
  "Bed Linen",
  "Bathroom",
  "Mattresses",
  "Furniture",
  "Bathroom",
  "Mattresses",
  "Furniture",
  "Bathroom",
  "Bed Linen",
  "Mattresses",
  "Bathroom",
  "Furniture",
  "Furniture",
  "Mattresses",
  "Mattresses",
  "Furniture",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Textiles",
  "Bed Linen",
  "Mattresses",
  "Bathroom",
  "Bed Linen",
  "Mattresses",
  "Mattresses",
  "Furniture",
  "Textiles",
  "Furniture",
  "Furniture",
  "Furniture",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Bed Linen",
  "Bed Linen",
  "Furniture",
  "Mattresses",
  "Furniture",
  "Mattresses",
  "Bathroom",
  "Textiles",
  "Bed Linen",
  "Bed Linen",
  "Duvets&Pillows",
  "Mattresses",
  "Homeware",
  "Furniture",
  "Furniture",
  "Mattresses",
  "Bathroom",
  "Bed Linen",
  "Mattresses",
  "Mattresses",
  "Bed Linen",
  "Bed Linen",
  "Bed Linen",
  "Mattresses",
  "Bed Linen",
  "Bathroom",
  "Mattresses",
  "Furniture",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Furniture",
  "Bathroom",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Bed Linen",
  "Bed Linen",
  "Homeware",
  "Bed Linen",
  "Furniture",
  "Furniture",
  "Bathroom",
  "Bed Linen",
  "Bed Linen",
  "Mattresses",
  "Mattresses",
  "Furniture",
  "Furniture",
  "Mattresses",
  "Mattresses",
  "Furniture",
  "Bed Linen",
  "Mattresses",
  "Furniture",
  "Bed Linen",
  "Furniture",
  "Bed Linen",
  "Duvets&Pillows",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Furniture",
  "Bed Linen",
  "Mattresses",
  "Garden",
  "Textiles",
  "Furniture",
  "Mattresses",
  "Mattresses",
  "Bed Linen",
  "Furniture",
  "Bed Linen",
  "Bed Linen",
  "Bed Linen",
  "Bed Linen",
  "Bed Linen",
  "Mattresses",
  "Bed Linen",
  "Mattresses",
  "Bed Linen",
  "Bed Linen",
  "Mattresses",
  "Bed Linen",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Furniture",
  "Furniture",
  "Textiles",
  "Bathroom",
  "Bed Linen",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Bed Linen",
  "Bed Linen",
  "Mattresses",
  "Mattresses",
  "Furniture",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Furniture",
  "Furniture",
  "Textiles",
  "Mattresses",
  "Bed Linen",
  "Furniture",
  "Homeware",
  "Garden",
  "Bed Linen",
  "Bed Linen",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Textiles",
  "Mattresses",
  "Mattresses",
  "Bed Linen",
  "Mattresses",
  "Furniture",
  "Furniture",
  "Furniture",
  "Furniture",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Bed Linen",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Bathroom",
  "Textiles",
  "Mattresses",
  "Mattresses",
  "Furniture",
  "Furniture",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Mattresses"
)

# 3) Define the 'product_category_level_2' vector (202 entries)
product_category_level_2 <- c(
  "mirror",
  "Mattresses",
  "sofa bed",
  "bed frame",
  "bed frame",
  "Towel",
  "Mattresses",
  "top mattress",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "dining chair",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Bed Linen",
  "pouffe",
  "Bed Linen",
  "Towel",
  "Mattresses",
  "desk",
  "Towel",
  "Mattresses",
  "bed frame",
  "Towel",
  "Sheets",
  "Mattresses",
  "Towel",
  "footstool",
  "bed frame",
  "Mattresses",
  "Mattresses",
  "shelving unit",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Curtain",
  "Sheets",
  "Mattresses",
  "Towel",
  "Sheets",
  "Mattresses",
  "top mattress",
  "bed frame",
  "TableTextile",
  "bed frame",
  "wardrobe",
  "bed frame",
  "Mattresses",
  "top mattress",
  "Mattresses",
  "Mattresses",
  "top mattress",
  "Mattresses",
  "Sheets",
  "Sheets",
  "sofa bed",
  "Mattresses",
  "stool",
  "Mattresses",
  "Towel",
  "TableTextile",
  "Sheets",
  "Sheets",
  "Pillow",
  "Mattresses",
  "Decoration",
  "pouffe",
  "shelving unit",
  "Mattresses",
  "Towel",
  "Sheets",
  "Mattresses",
  "top mattress",
  "Sheets",
  "Sheets",
  "Bed Linen",
  "Mattresses",
  "Sheets",
  "Towel",
  "Accessorries",
  "nest of tables",
  "continental bed",
  "Mattresses",
  "Mattresses",
  "chest of drawers",
  "Towel",
  "continental bed",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Bed Linen",
  "Bed Linen",
  "Decoration",
  "Sheets",
  "sofa bed",
  "desk",
  "Towel",
  "Sheets",
  "Sheets",
  "top mattress",
  "Mattresses",
  "bed frame",
  "pouffe",
  "Mattresses",
  "Mattresses",
  "bench",
  "Bed Linen",
  "Mattresses",
  "bed frame",
  "Sheets",
  "pouffe",
  "Sheets",
  "Pillow",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "sofa bed",
  "Sheets",
  "Mattresses",
  "Garden table",
  "Curtain",
  "armchair",
  "Mattresses",
  "top mattress",
  "Sheets",
  "Decoration",
  "Sheets",
  "Sheets",
  "Bed Linen",
  "Bed Linen",
  "Sheets",
  "top mattress",
  "Sheets",
  "Mattresses",
  "Bed Linen",
  "Bed Linen",
  "continental bed",
  "Bed Linen",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "Mattresses",
  "chest of drawers",
  "pedestal",
  "Curtain",
  "Towel",
  "Bed Linen",
  "Accessorries",
  "Mattresses",
  "Accessorries",
  "Sheets",
  "Bed Linen",
  "Accessorries",
  "Mattresses",
  "shelving unit",
  "continental bed",
  "Accessorries",
  "Mattresses",
  "decoration",
  "nest of tables",
  "Curtain",
  "Mattresses",
  "Bed Linen",
  "bedside table",
  "lamp",
  "Garden cushion",
  "Bed Linen",
  "Bed Linen",
  "top mattress",
  "Mattresses",
  "Accessorries",
  "Curtain",
  "Accessorries",
  "continental bed",
  "Bed Linen",
  "Mattresses",
  "office chair",
  "sofa bed with chaise longue",
  "dining chair",
  "dining chair",
  "Accessorries",
  "Accessorries",
  "Accessorries",
  "Bed Linen",
  "top mattress",
  "Accessorries",
  "top mattress",
  "Mattresses",
  "top mattress",
  "Towel",
  "TableTextile",
  "Mattresses",
  "Accessorries",
  "sofa bed",
  "Decoration",
  "Accessorries",
  "top mattress",
  "Mattresses",
  "Mattresses",
  "Mattresses"
)

# 4) Combine all three vectors into a data frame named 'lookup'
lookup <- data.frame(
  product_title = product_title,
  product_group_level_1 = product_group_level_1,
  product_category_level_2 = product_category_level_2,
  stringsAsFactors = FALSE
)

# 5) Print to confirm
print(lookup, n = nrow(lookup))


sum(is.na(data))

library(dplyr)

# 1) Convert empty strings in data to NA (optional)
data <- data %>%
  mutate(
    product_group_level_1 = na_if(product_group_level_1, ""),
    product_category_level_2 = na_if(product_category_level_2, "")
  )

# 2) Create data_joined by joining data with lookup on product_title
data_joined <- data %>%
  left_join(lookup, by = "product_title", suffix = c("", ".lkp")) %>%
  # 3) Replace NAs in original columns with the lookup columns
  mutate(
    product_group_level_1 = coalesce(product_group_level_1, product_group_level_1.lkp),
    product_category_level_2 = coalesce(product_category_level_2, product_category_level_2.lkp)
  ) %>%
  # 4) Remove the extra lookup columns
  dplyr::select(-ends_with(".lkp"))

# 5) Print the complete resulting data frame
print(data_joined, n = nrow(data_joined))

# Convert the 'date' column to Date type
data$date <- as.Date(data$date, format = "%d.%m.%Y")

#Including 
january_first_sum <- sum(data$order_value_ex_vat_ex_freight[data$date == "2024-01-01"])

print(paste("Total order value for January 1st: $", round(january_first_sum, 2)))
# Convert all non-numeric columns (besides 'date') to factors
data[] <- lapply(data, function(x) if(is.character(x)) as.factor(x) else x)

# Check the structure of the dataset to confirm the changes
str(data)

# Rename the column 'order_value_ex_vat_ex_freight' to 'Revenue'
data <- data %>%
  dplyr::rename(revenue = order_value_ex_vat_ex_freight)
# impute NA customer id's with 999999999 for now. will be removed in CLV probably
data <- data %>%
  mutate(customer_id = replace_na(customer_id, 9999999999))

# only revenue greater than 0, returns are excluded
data <- data %>% 
  filter(revenue > 0)

# filtering out Result rows
data <- data %>%
  filter(customer_id != "Result")

january_first_sum_after_cleaning <- sum(data$revenue[data$date == "2024-01-01"])

sum(is.na(data))

str(data)

# This basically proves that their own case descriptions is wrong where they say they have 420k rows and 170k orders. Based on result for 1st day, we can only reach that if we remove duplicates, which contradicts what they write in their own description.
# January 1st sums to 338135 without data cleaning which includes the result row of 169 068. After removing that and cleaning NA's what we get is 167 614 which is approx. equal to the result. We then conclude that it matches so the duplicate rows should indeed be removed!
# There is also an anomaly which contradicts what they write in the case description.
# There are 424.965 rows split into 173.275 orders, meaning ∼2,5 items per order. They say that but there are anomalies where in 1 row they have the revenue exactly 5 times higher than for the same product in other rows. This implies 5 of those products was purchased at that time. This contradicts the 1 row = 1 product bought logic they imply. The first point in this comment is also a contradiction.
```

```{r #APPLICATION1}

#Cleaning of data

#Cleaning the data on na customers but also revenue above 0
data_clean_rfm <- data %>% 
  filter(!is.na(customer_id) & revenue > 0)


#Visualization of the 3 rfm variables

# Revenue histogram
hist(data_clean_rfm$revenue, main = "Histogram of Revenue", col = "blue", border = "black")
# Check for NAs
sum(is.na(data_clean_rfm$revenue))      # Count NAs in revenue



# Customer ID bar plot
barplot(table(data_clean_rfm$customer_id), main = "Customer ID Distribution", col = "blue")
sum(is.na(data_clean_rfm$customer_id))  # Count NAs in customer_id


# Date bar plot
barplot(table(data_clean_rfm$date), main = "Date Distribution", col = "blue")
sum(is.na(data_clean_rfm$date))         # Count NAs in date

#CAN BE SEEN no NAs and also no negative variables, can proceed with the RFM model running
 
```

```{r #Application 1 - RFM model}
#RFM model 

analysis_date = as.Date("2024-12-31")

# Run the RFM analysis
rfm_result <- rfm_table_order(data_clean_rfm, 
                              customer_id, 
                              date, 
                              revenue, 
                              analysis_date = analysis_date)

# Step 3: Visualize RFM Results
# Heatmap visualization of RFM scores
rfm_plot_heatmap(rfm_result)

# Bar chart of RFM scores
rfm_bar_chart(rfm_result)




# Step 4: Segment Customers based on RFM scores
# Define RFM segment categories
segment_names <- c("Champions", "Loyal Customers", "Potential Loyalist", 
                   "New Customers", "Promising", "Need Attention", "About To Sleep", 
                   "At Risk", "Can't Lose Them", "Lost")

# Set upper and lower bounds for Recency, Frequency, and Monetary
recency_lower   <- c(4, 2, 3, 4, 3, 2, 2, 1, 1, 1)
recency_upper   <- c(5, 5, 5, 5, 4, 3, 3, 2, 1, 2)
frequency_lower <- c(4, 3, 1, 1, 1, 2, 1, 2, 4, 1)
frequency_upper <- c(5, 5, 3, 1, 1, 3, 2, 5, 5, 2)
monetary_lower  <- c(4, 3, 1, 1, 1, 2, 1, 2, 4, 1)
monetary_upper  <- c(5, 5, 3, 1, 1, 3, 2, 5, 5, 2)

# Apply segments based on RFM scores
segment <- rfm_segment(rfm_result, 
                       segment_names,
                       recency_lower, recency_upper,
                       frequency_lower, frequency_upper,
                       monetary_lower, monetary_upper)

# View the segmented customers
head(segment)

# Step 5: Visualize RFM Segments
# Recency by segment
rfm_plot_median_recency(segment, sort = TRUE)

# Monetary by segment
rfm_plot_median_monetary(segment, sort = TRUE)

# Frequency by segment
rfm_plot_median_frequency(segment, sort = TRUE)
```

```{r #APPLICATION 2 - so far some data exploration}
#APPLICATION 2

#starting with descriptive statistics

#Cleaning the data on na customers but also revenue above 0
data_application2 <- data %>% 
  filter(!is.na(customer_id))

#DESCRIPTIVE STATISTICS

#### NR of orders per month ####
# Extract month and year from the date
data_application2$date_month <- format(as.Date(data_application2$date), "%Y-%m")

# Plot number of orders per month
ggplot(data_application2) + 
  geom_bar(aes(x = date_month), colour = "grey20", fill = "grey80") + 
  ggtitle("Orders per Month") + 
  xlab("Month") +
  ylab("Number of Orders") +
  theme(panel.background = element_rect(fill = "grey94")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text = element_text(size = 14, angle = 45, hjust = 1),  # Rotate text to 45 degrees
        axis.title = element_text(size = 14))


#### NR of orders per customer####

# Truncate orders per customer
# Step 1: Calculate the number of orders per customer
order_count_per_customer <- table(data_application2$customer_id)

# Step 2: Truncate the number of orders to 15
order_count_truncate <- pmin(order_count_per_customer, 15)

# Step 3: Create a data frame for plotting
order_summary <- as.data.frame(table(order_count_truncate))

# Step 4: Plot the number of orders per customer using a bar plot
ggplot(order_summary, aes(x = as.factor(order_count_truncate), y = Freq)) + 
  geom_bar(stat = "identity", fill = "grey80", colour = "grey20") + 
  ggtitle("Orders per Customer (Truncated to 15)") +  
  xlab("Total Number of Orders") +
  ylab("Number of Customers") +
  theme(panel.background = element_rect(fill = "grey94")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text = element_text(size = 14), axis.title = element_text(size = 14))

####  Days Between Orders  ####

# Sort data by customer_id and date
data_application2 <- data_application2 %>%
  arrange(customer_id, date)

# Calculate days since the last order for each customer
data_application2 <- data_application2 %>%
  group_by(customer_id) %>%
  mutate(days_since_last_order = as.numeric(difftime(date, lag(date), units = "days"))) %>%
  ungroup()

# Replace NA values (for the first order) with 0
data_application2$days_since_last_order[is.na(data_application2$days_since_last_order)] <- 0

# Remove customers with only one order (days_since_last_order = 0)
data_application2_filtered <- data_application2 %>%
  filter(days_since_last_order > 0)

# Now create the subset for the relevant columns (order_id, customer_id, days_since_last_order)
daysdata <- subset(data_application2_filtered[, c("order_id", "customer_id", "days_since_last_order")])

# Calculate the mean of the days_since_last_order for each customer
daysdatamean <- aggregate(days_since_last_order ~ customer_id, data = daysdata, FUN = mean)

# Plot histogram of the days between orders
ggplot(daysdatamean) + 
  geom_histogram(aes(x = days_since_last_order), binwidth = 5, colour = "grey20", fill = "grey80") +
  ggtitle("Days Between Orders customers with at least 2 orders") +  
  xlab("Average Days Between Orders") +
  ylab("Number of Customers") +
  theme(panel.background = element_rect(fill = "grey94")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(axis.text = element_text(size = 17, face = "plain"),
        axis.title = element_text(size = 17, face = "plain"),
        title = element_text(size = 16, face = "plain"))


#### Postal code distribution - also matching with acutal cities #####


# Read the postal codes data file
postal_codes <- read.csv("postal_codes_Romania.csv")

# Convert all columns to factors in the postal_codes dataframe
postal_codes[] <- lapply(postal_codes, as.factor)

# Convert all non-numeric columns to factors in the data_application2 dataframe
data_application2[] <- lapply(data_application2, function(x) if (is.character(x)) as.factor(x) else x)

# Ensure that the postal_code and customer_zip_code are both of the same type (character for this case)
postal_codes$postal_code <- as.character(postal_codes$postal_code)
data_application2$customer_zip_code <- as.character(data_application2$customer_zip_code)

# Filter out rows with NA in both customer_zip_code and postal_code columns
data_application2_filtered <- data_application2 %>%
  filter(!is.na(customer_zip_code))  # Remove rows with NA in customer_zip_code
app2_subset <- subset(data_application2_filtered[, c("customer_id", "customer_zip_code")])
app2_subset <- app2_subset%>%
  dplyr::rename(postal_code = customer_zip_code)

str(app2_subset)

#filter the postal one
postal_codes_filtered <- postal_codes %>%
  filter(!is.na(postal_code))  # Remove rows with NA in postal_code
postal_subset <- subset(postal_codes_filtered[, c("postal_code", "Judet")])

str(postal_subset)

# Assuming app2_subset and postal_subset are already defined
# Join the app2_subset with postal_subset based on the postal_code
joined_data <- app2_subset %>%
  dplyr::left_join(postal_subset, by = "postal_code") %>%
  mutate(matched_postal_code = coalesce(postal_code, postal_code))


str(joined_data)

#### PLOT ####

# Replace NA in 'Judet' with 'Bucuresti'
joined_data$Judet[is.na(joined_data$Judet)] <- "Bucuresti"

# Check the result to make sure NAs were replaced
sum(is.na(joined_data$Judet))  # Should return 0 if all NAs are replaced



# Ensure 'Judet' is treated as a character and 'customer_id' is numeric
joined_data$Judet <- as.character(joined_data$Judet)

# Ensure the encoding of Judet is correct (UTF-8)
joined_data$Judet <- iconv(joined_data$Judet, from = "UTF-8", to = "ASCII//TRANSLIT")

# Count the occurrences of each Judet
Judet_counts <- table(joined_data$Judet)

# Sort the counts in descending order
Judet_counts_sorted <- sort(Judet_counts, decreasing = TRUE)

# Create a bar plot of the sorted Judet counts
barplot_heights <- barplot(Judet_counts_sorted, 
        main = "Count of Customers per Judet (Sorted)", 
        xlab = "Judet", 
        ylab = "Count of Customers", 
        las = 2,  # Rotate x-axis labels for readability
        col = "steelblue",
        cex.names = 0.6)  # Reduce the size of X-axis labels

# Count how many NAs are in the 'Judet' column
na_count_judet <- sum(is.na(joined_data$Judet))

# Print the result
print(na_count_judet)


#### BONUS #####

# Install and load the necessary libraries
# install.packages("tidygeocoder")
# install.packages("sf")
# install.packages("ggplot2")
library(tidygeocoder)
library(sf)
library(ggplot2)

# Get unique Judet names (remove duplicates) and convert to dataframe
unique_judets_df <- data.frame(Judet = unique(joined_data$Judet))

# Geocode Judet names to get latitude and longitude
# Specify 'address' column explicitly in geocode function
geocoded_judets <- tidygeocoder::geocode(unique_judets_df, address = "Judet", method = 'osm')

# Merge geocoded data back with customer data to include coordinates
judet_geo_data <- data.frame(Judet = unique_judets_df$Judet, 
                             Latitude = geocoded_judets$lat, 
                             Longitude = geocoded_judets$long)

# Update Latitude and Longitude for the row "Alba"
judet_geo_data$Latitude[judet_geo_data$Judet == "Alba"] <- 46.1559
judet_geo_data$Longitude[judet_geo_data$Judet == "Alba"] <- 23.5556

# Count occurrences of each Judet in your original dataset
Judet_counts <- table(joined_data$Judet)
Judet_counts_df <- data.frame(Judet = names(Judet_counts), Count = as.vector(Judet_counts))

# Merge the counts with the geocoded data
geo_count_data <- merge(judet_geo_data, Judet_counts_df, by = "Judet")  # Convert to sf object for spatial plotting

# Convert the data to an sf object for spatial plotting
geo_count_sf <- st_as_sf(geo_count_data, coords = c("Longitude", "Latitude"), crs = 4326)

# Plot the map with customer counts
ggplot(geo_count_sf) +
  geom_sf(aes(color = Count, size = Count), alpha = 0.7) +  # Customize size/color of points
  scale_color_viridis_c() +  # Color scale for customer counts
  labs(title = "Customer Counts per Judet", fill = "Customer Count") +
  theme_minimal() +
  theme(legend.position = "bottom")

View(unique_judets_df)

```

## Association Rules Mining

```{r ## Association Rules mining new}
# Take dataset
library(skimr)
data_asm <- data

#Cleaning the data on na customers but also revenue above 0
data_asm <- data_asm %>% 
  filter(!is.na(customer_id) & revenue > 0)

skim(data_asm)

```

```{r}
transacData <- plyr::ddply(data_asm, c("order_id","date"),
                           function(df1)paste(df1$product_title,collapse = ","))


head(transacData)

transacData$order_id <- NULL

transacData$date <- NULL

colnames(transacData) <- c("items")
head(transacData)

basket_list <- strsplit(transacData$items, ",")

library(arules)
tr <- as(basket_list, "transactions")

summary(tr)

```

```{r}
library(RColorBrewer)
itemFrequencyPlot(tr,topN=20,type="absolute",col=brewer.pal(8,'Pastel2'), 
                  main="Absolute Item Frequency Plot")

itemFrequencyPlot(tr,topN=20,type="relative",col=brewer.pal(8,'Pastel2'),
                  main="Relative Item Frequency Plot")

```

```{r}
# Look for association rules

# somewhat strict confidence
association.rules <- apriori(tr, 
                             parameter = list(supp=0.001, conf=0.8,maxlen=10))

summary(association.rules)

```

```{r}
inspect(association.rules)

sortedRules1 <- sort(association.rules,by="lift",decreasing=TRUE)

inspect(sortedRules1) 
```

```{r}
# confidence set lower at 0.6
# this has some implications on the statistical 
relaxed.rules <- apriori(tr, 
                             parameter = list(supp=0.0005, conf=0.6,maxlen=10))
summary(relaxed.rules)

inspect(relaxed.rules)

sortedRules2 <- sort(relaxed.rules,by="lift",decreasing=TRUE)

inspect(sortedRules2) 

```

```{r}
# plot association rules - relaxed
library(arulesViz)
subRules <- relaxed.rules[quality(relaxed.rules)$confidence > 0.4]
plot(subRules)
```

```{r}
# interactive plot

plot(subRules, method = "two-key plot")

```
